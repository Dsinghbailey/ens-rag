<!DOCTYPE html>
<html>

<head>
	<title>SSE Test</title>
	<style>
		body {
			font-family: Arial, sans-serif;
			margin: 20px;
		}

		#output {
			white-space: pre-wrap;
			border: 1px solid #ccc;
			padding: 10px;
			height: 300px;
			overflow-y: auto;
			margin-bottom: 20px;
		}

		button {
			padding: 10px;
			background: #4285f4;
			color: white;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			margin-bottom: 10px;
		}

		button:hover {
			background: #3367d6;
		}

		#raw {
			margin-top: 20px;
			font-family: monospace;
			font-size: 12px;
			color: #666;
		}
	</style>
</head>

<body>
	<h1>Server-Sent Events Test</h1>

	<button id="connectDebug">Connect to Debug Endpoint</button>
	<button id="connectChat">Connect to Chat Endpoint with Test Message</button>
	<button id="clear">Clear Output</button>

	<h2>Output:</h2>
	<div id="output"></div>

	<h2>Raw Data:</h2>
	<div id="raw"></div>

	<script>
		const output = document.getElementById('output');
		const rawOutput = document.getElementById('raw');
		let eventSource = null;

		document.getElementById('connectDebug').addEventListener('click', () => {
			if (eventSource) {
				eventSource.close();
			}

			output.innerHTML = 'Connecting to /debug-sse...\n';
			rawOutput.innerHTML = '';

			fetch('http://localhost:3001/debug-sse', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				}
			}).then(response => {
				const reader = response.body.getReader();
				const decoder = new TextDecoder();

				function read() {
					reader.read().then(({ done, value }) => {
						if (done) {
							output.innerHTML += '\nStream complete\n';
							return;
						}

						const chunk = decoder.decode(value);
						rawOutput.innerHTML += 'Chunk: ' + chunk.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '\n';

						// Parse SSE format
						const lines = chunk.split('\n\n');
						for (const line of lines) {
							if (line.startsWith('data: ')) {
								try {
									const data = line.substring(6);
									output.innerHTML += 'Received: ' + data + '\n';

									try {
										const json = JSON.parse(data);
										output.innerHTML += 'Parsed JSON: ' + JSON.stringify(json, null, 2) + '\n';
									} catch (e) {
										if (data !== '[DONE]') {
											output.innerHTML += 'Not valid JSON: ' + e.message + '\n';
										} else {
											output.innerHTML += 'Received [DONE] marker\n';
										}
									}
								} catch (e) {
									output.innerHTML += 'Error parsing data: ' + e.message + '\n';
								}
							}
						}

						output.scrollTop = output.scrollHeight;
						read();
					}).catch(error => {
						output.innerHTML += 'Error reading stream: ' + error.message + '\n';
					});
				}

				read();
			}).catch(error => {
				output.innerHTML += 'Fetch error: ' + error.message + '\n';
			});
		});

		document.getElementById('connectChat').addEventListener('click', () => {
			if (eventSource) {
				eventSource.close();
			}

			output.innerHTML = 'Connecting to /chat with test message...\n';
			rawOutput.innerHTML = '';

			fetch('http://localhost:3001/chat', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({
					messages: [
						{ role: 'user', content: 'What is ENS?' }
					],
					customerId: 1
				})
			}).then(response => {
				const reader = response.body.getReader();
				const decoder = new TextDecoder();

				function read() {
					reader.read().then(({ done, value }) => {
						if (done) {
							output.innerHTML += '\nStream complete\n';
							return;
						}

						const chunk = decoder.decode(value);
						rawOutput.innerHTML += 'Chunk: ' + chunk.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '\n';

						// Parse SSE format
						const lines = chunk.split('\n\n');
						for (const line of lines) {
							if (line.startsWith('data: ')) {
								try {
									const data = line.substring(6);
									output.innerHTML += 'Received: ' + data + '\n';

									try {
										const json = JSON.parse(data);
										output.innerHTML += 'Parsed JSON: ' + JSON.stringify(json, null, 2) + '\n';
									} catch (e) {
										if (data !== '[DONE]') {
											output.innerHTML += 'Not valid JSON: ' + e.message + '\n';
										} else {
											output.innerHTML += 'Received [DONE] marker\n';
										}
									}
								} catch (e) {
									output.innerHTML += 'Error parsing data: ' + e.message + '\n';
								}
							}
						}

						output.scrollTop = output.scrollHeight;
						read();
					}).catch(error => {
						output.innerHTML += 'Error reading stream: ' + error.message + '\n';
					});
				}

				read();
			}).catch(error => {
				output.innerHTML += 'Fetch error: ' + error.message + '\n';
			});
		});

		document.getElementById('clear').addEventListener('click', () => {
			output.innerHTML = '';
			rawOutput.innerHTML = '';
		});
	</script>
</body>

</html>